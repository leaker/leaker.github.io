<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=description content><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=keywords content="c++,enable_shared_from_this,shared_ptr,"><meta property="og:type" content="article"><meta property="og:description" content><meta property="og:title" content="类 enable_shared_from_this 的经验总结"><meta property="og:site_name" content="逃避虽然可耻但有用"><meta property="og:url" content="https://www.leelib.com/2015/12/13/enable-shared-from-this.html"><meta property="og:locale" content="zh-CN"><meta property="article:published_time" content="2015-12-13T23:32:07+0800"><meta property="article:modified_time" content="2015-12-13T23:32:07+0800"><meta property="article:tag" content="c++"><meta property="article:tag" content="enable_shared_from_this"><meta property="article:tag" content="shared_ptr"><base href=https://www.leelib.com/2015/12/13/enable-shared-from-this.html><title>类 enable_shared_from_this 的经验总结 | 逃避虽然可耻但有用</title><link rel=canonical href=https://www.leelib.com/2015/12/13/enable-shared-from-this.html><link rel=stylesheet href=https://www.leelib.com/css/fika.min.e981b6773011e9ebef0acb91938bbaee62327378a3c72ad2503f78a42e50d4ea.css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon></head><body><header><div><div id=imglogo><a href=https://www.leelib.com/><img src=/img/logo.webp alt=逃避虽然可耻但有用 title=逃避虽然可耻但有用></a></div><div id=textlogo><h1 class=site-name><a href=https://www.leelib.com/ title=逃避虽然可耻但有用>逃避虽然可耻但有用</a></h1><h2 class=blog-motto>少壮不努力，一生在内地</h2></div><nav class=animated><ul><li><a href=/>主页</a></li><li><a href=/archives/index.html>归档</a></li><li><a href=/about/index.html>关于</a></li><li><a href=/disappear/index.html>消失</a></li></ul></nav></div></header><div id=container><div id=main class=post><article class="post-expand post" itemprop=articleBody><header class="article-info clearfix"><h1 itemprop=name><a href=https://www.leelib.com/2015/12/13/enable-shared-from-this.html title="类 enable_shared_from_this 的经验总结" itemprop=url>类 enable_shared_from_this 的经验总结</a></h1><p class=article-time><time datetime="2015-12-13 23:32:07 +0800 +0800" itemprop=datePublished>2015-12-13</time></p></header><div class=article-content><div id=toc class=toc-article><strong class=toc-title>文章目录</strong><ol class=toc><nav id=TableOfContents><ul><li><a href=#不能再构造函数内使用-shared_from_this-函数>不能再构造函数内使用 shared_from_this() 函数</a></li><li><a href=#子类无法重复继承>子类无法重复继承</a></li></ul></nav></ol></div><h1 id=不能再构造函数内使用-shared_from_this-函数>不能再构造函数内使用 shared_from_this() 函数</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>class_a</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>enable_shared_from_this<span style=color:#f92672>&lt;</span>class_a<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    class_a(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>auto</span> <span style=color:#a6e22e>self</span>(shared_from_this());<span style=color:#75715e>// 这里会报 bad_weak_ptr 错误
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h1 id=子类无法重复继承>子类无法重复继承</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>class_a</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>enable_shared_from_this<span style=color:#f92672>&lt;</span>class_a<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>class_b</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> class_a, <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>enable_shared_from_this<span style=color:#f92672>&lt;</span>class_a<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>这段代码将无法通过编译。
如果想返回子类的 shared_from_this 指针，则可以进行如下操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>class_a</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> std<span style=color:#f92672>::</span>enable_shared_from_this<span style=color:#f92672>&lt;</span>class_a<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>virtual</span> <span style=color:#f92672>~</span>class_a()<span style=color:#75715e>// 为了确保 dynamic_pointer_cast 可以工作，需要父类拥有虚函数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {}
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>class_b</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> class_a
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>shared_ptr<span style=color:#f92672>&lt;</span>class_b<span style=color:#f92672>&gt;</span> shared_from_this(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>dynamic_pointer_cast<span style=color:#f92672>&lt;</span>class_b<span style=color:#f92672>&gt;</span>(class_a<span style=color:#f92672>::</span>shared_from_this());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><strong>通常来说如果定义一个类时，如果这个类可能被继承使用时，将这个类的析构函数定义为虚函数来确保析构的调用顺序</strong></p></div><footer class="article-footer clearfix"><div class=article-catetags><div class=article-categories><span></span>
<a class=article-category-link href=https://www.leelib.com/categories/programing.html>programing</a></div><div class=article-tags><span></span>
<a href=https://www.leelib.com/tags/c++.html>c++</a>
<a href=https://www.leelib.com/tags/enable_shared_from_this.html>enable_shared_from_this</a>
<a href=https://www.leelib.com/tags/shared_ptr.html>shared_ptr</a></div></div></footer></article><nav class="article-nav clearfix"><div class=prev><a href=https://www.leelib.com/2016/01/21/git.html title=Git的常用命令收集><p><strong>上一篇</strong></p><span>Git的常用命令收集</span></a></div><div class=next><a href=https://www.leelib.com/2015/09/16/vs2013-command-prompt-here.html title="Win10里添加目录右键菜单 VS2013 Command Prompt Here"><p><strong>下一篇</strong></p><span>Win10里添加目录右键菜单 VS2013 Command Prompt Here</span></a></div></nav></div><div id=asidepart><aside class=clearfix><div class=categorieslist><p class=asidetitle>文章分类</p><ul><li><span class=count>1</span>
<a href=/categories/deploy.html title=deploy>deploy</a></li><li><span class=count>1</span>
<a href=/categories/interesting.html title=interesting>interesting</a></li><li><span class=count>29</span>
<a href=/categories/linux.html title=linux>linux</a></li><li><span class=count>5</span>
<a href=/categories/notices.html title=notices>notices</a></li><li><span class=count>23</span>
<a href=/categories/programing.html title=programing>programing</a></li><li><span class=count>1</span>
<a href=/categories/sites.html title=sites>sites</a></li><li><span class=count>10</span>
<a href=/categories/summarys.html title=summarys>summarys</a></li><li><span class=count>1</span>
<a href=/categories/works.html title=works>works</a></li></ul></div><div class=tagslist><p class=asidetitle>文章标签</p><ul class=clearfix><li><a href=/tags/c.html title=c>c<sup>3</sup></a></li><li><a href=/tags/centos.html title=centos>centos<sup>5</sup></a></li><li><a href=/tags/compress.html title=compress>compress<sup>2</sup></a></li><li><a href=/tags/conf.html title=conf>conf<sup>2</sup></a></li><li><a href=/tags/gcc.html title=gcc>gcc<sup>2</sup></a></li><li><a href=/tags/git.html title=git>git<sup>3</sup></a></li><li><a href=/tags/https.html title=https>https<sup>2</sup></a></li><li><a href=/tags/install.html title=install>install<sup>4</sup></a></li><li><a href=/tags/kernel.html title=kernel>kernel<sup>3</sup></a></li><li><a href=/tags/libc.html title=libc>libc<sup>2</sup></a></li><li><a href=/tags/linux.html title=linux>linux<sup>12</sup></a></li><li><a href=/tags/ln.html title=ln>ln<sup>2</sup></a></li><li><a href=/tags/make.html title=make>make<sup>3</sup></a></li><li><a href=/tags/python.html title=python>python<sup>3</sup></a></li><li><a href=/tags/safeseh.html title=safeseh>safeseh<sup>2</sup></a></li><li><a href=/tags/sudo.html title=sudo>sudo<sup>2</sup></a></li><li><a href=/tags/ubuntu.html title=ubuntu>ubuntu<sup>8</sup></a></li><li><a href=/tags/windows.html title=windows>windows<sup>3</sup></a></li><li><a href=/tags/yum.html title=yum>yum<sup>4</sup></a></li><li><a href=/tags/zlib.html title=zlib>zlib<sup>4</sup></a></li></ul></div><div class=rsspart><a href=/atom.xml target=_blank title=rss>RSS 订阅</a></div></aside></div></div><footer><div id=footer><div class=line><span></span><div class=author></div></div><section class=info><p>Hello, this is leaker's blog in github.<br>Leaker: "Living without an aim is like sailing without a compass."</p></section><div class=social-font class=clearfix><a href=mailto:admin@leelib.com target=_blank class=icon-email title="Email Me"></a></div><p class=copyright>Powered by <a rel=noopener title=Hugo href=https://gohugo.io target=_blank>Hugo</a> and Theme by <a rel=noopener title=Fika href=https://github.com/leaker/hugo-theme-fika target=_blank>Fika</a> © 2022
<a href=/about/index.html target=_blank title=leaker>leaker</a>
<a target=_blank rel="noopener noreferrer" href=http://www.beian.miit.gov.cn/ class=report-link><img rel=nofollow title="备案号： 陕ICP备20006522号" class=report-img src=/images/report-img.webp><span class=report-link-text>陕ICP备20006522号</span></a></p></div></footer></body></html>